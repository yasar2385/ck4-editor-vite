<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link href="AnotCSS/theme-dark/annotorious-dark.css" rel="stylesheet" />
    <style>
        html, body {
            min-height: 100%;
            padding: 0;
            margin: 0;
            line-height: 22px;
            position: absolute;
        }
        .column {
            /*border-width: 5px;*/
            border-style: initial;
            position: relative;
            float: none;
            height: 100%;
            text-align: center;
        }

    </style>
    <script src="annotorious.min.js"></script>
    <script src="../../../UI/lib/jquery/jquery.min.js"></script>
    <script type="text/javascript">
        /*****************Add && show Annotation data ******************/
        var editor = window.parent.GlobalEditor;
        var selection = editor.getSelection();
        var elemt = selection.getStartElement();
        var arr = new Array();
        if (!!elemt.getAscendant('img', true)) {
            var imgid = $(elemt).attr('id');
            if (!imgid && imgid == undefined) imgid = $(elemt.$).parent().attr('id');
                $(elemt.$).parents('.fig').find('span[data-class="ckcommentsfull"]').each(function(){
				var txt = $(this).find('span').attr('data-annotate');
                var querytext = $(this).find('span').attr('data-user-comment-box');
                if (txt != null && typeof txt != 'undefined' && querytext != "") {
                    var dataAnnotion = txt.split(',');
                    var myAnnotation = {
                        src: dataAnnotion[4] /*+ ':' + dataAnnotion[5] + ':' + dataAnnotion[6]*/,
                        text: querytext,
                        shapes: [{
                            type: 'rect',
                            /** The shape geometry (relative coordinates) **/
                            geometry: { x: parseFloat(dataAnnotion[0]), y: parseFloat(dataAnnotion[1]), width: parseFloat(dataAnnotion[2]), height: parseFloat(dataAnnotion[3]) }
                        }]
                    }
                    arr.push(myAnnotation);
                    window.addEventListener('load', function () {
                        for (var k = 0; k < arr.length; k++) {
                            this.anno.addAnnotation(arr[k]);
                        }
                    });
                }
            })
        }
    </script>
</head>
<body>
    <div class="column"><img alt="" class="annotatable" id="imgID" /></div>
    <script type="text/javascript">
        var arritem = window.top.parent.ImageAnnotateDialog.ImgFunc.getImgSRC();
        var realWidth = arritem[1];
        var realHeight = arritem[2];
        var a = $('#imgID');
        $(a).attr("src", arritem[0]);
        var wid = parseInt(realWidth);
        var hig = parseInt(realHeight);
        var bodywidth = wid, bodyhight = hig;
        if (bodywidth < 300) {
            bodywidth = 295;
            $('body').width(bodywidth + "px");
        }
        if (bodyhight < 200) {
            bodyhight = 195;
            $('body').height(bodyhight + "px");
        }
        if (hig > 700) {
            $(a).attr('style', 'width:' + parseInt(bodywidth + 95) + 'px; height:' + parseInt(bodyhight - 220) + 'px;top:10px;position:relative;left:0px;z-index:0;');
            if (wid > 300 && hig > 200) {
            }
        } else {
            wid = bodywidth; hig = bodyhight;
            if ($(window.top).width() < wid) {
                wid = $(window.top).width();
                var resizewidth = parseInt((wid * 30) / 100);
                wid -= resizewidth;
            }
            if ($(window.top).height() < hig) {
                hig = $(window.top).height();
                var resizeheight = parseInt((hig * 30) / 100);
                hig -= resizeheight;
            }
            if (wid > 700) {
                var resizeWidth = parseInt((wid * 20) / 100);
                wid -= resizeWidth;
            }
            else {
                var resizeWidth = parseInt((wid * 20) / 100);
                wid += resizeWidth;
            }
            if (hig > 400) {
                var resizeHeight = parseInt((hig * 20) / 100);
                hig -= resizeHeight;
            }
            else {
                var resizeHeight = parseInt((hig * 20) / 100);
                hig += resizeHeight;
            }
            $(a).attr('style', 'width:' + parseInt(bodywidth + 65) + 'px; height:' + parseInt(bodyhight + 40) + 'px;top:10px;position:relative;left:0px;z-index:0;');
            if (bodywidth > 700) {
                $('body').width(parseInt(wid) + "px");
            }
            if (bodyhight > 400) {
                $('body').height(parseInt(hig) + "px");
            }
        }
        
        anno.addHandler('onAnnotationCreated', function (annotation) {
        var dataAnnot = "";
        var teks = annotation.text;
        if (teks != "") {
            var contextURL = annotation.src;
            var x = annotation.shapes[0].geometry.x;
            var y = annotation.shapes[0].geometry.y;
            var width = annotation.shapes[0].geometry.width;
            var height = annotation.shapes[0].geometry.height;
            dataAnnot = x + "," + y + "," + width + "," + height + ","  + contextURL;
            var editor = window.top.parent.GlobalEditor;
            var selection = editor.getSelection().getStartElement();
            if(!!$(selection.$).parents('.fig').length){
                var figID = $(selection.$).parents('.fig').attr('id');
                var nTxt=teks,nId=window.parent.s4();
                var htmlStringDOM = window.parent.noteSting(nTxt,0,nId,'note','new');		
                $(htmlStringDOM).find('[data-user-comment-box]').attr('data-annotate',dataAnnot);
                console.log(htmlStringDOM)        
                //$(selection.$).parents('.fig').find('.caption .p').after(htmlStringDOM);        
                let dom = window.top.parent.document.getElementById('aaa');
                // ? set data for  DOM manipulation
                dom.innerHTML = editor.getData(); 
                let cur_img =  dom.querySelector('#' + figID);
                let caption =  cur_img.querySelector('.caption .p');
                if(caption)  $(caption).after(htmlStringDOM);
                else $(cur_img).find('.graphic').before(htmlStringDOM);
                NoteRenumber_Temp(editor, dom);
                // editor.setData(dom.innerHTML);
                window.top.parent.SET_DATA.setNewData(dom,{DOM_Empty:!0, reGenerateAll: !0, cleanHTML: !0},figID);
                // TODO to handle
                window.top.parent.ImageAnnotateDialog.closeDialog();
            }
        }    
    });
    anno.addHandler('onAnnotationRemoved', function (annotation) {
        console.log(annotation);
    });
    anno.addHandler('beforeAnnotationRemoved', function (annotation) {
        console.log(annotation);
        var editor = window.top.parent.GlobalEditor;
        var contextURL = annotation.src;
        var x = annotation.shapes[0].geometry.x;
        var y = annotation.shapes[0].geometry.y;
        var width = annotation.shapes[0].geometry.width;
        var height = annotation.shapes[0].geometry.height;
        var dataAnnotate = x + "," + y + "," + width + "," + height + ","  + contextURL;
        let dom = window.top.parent.document.getElementById('aaa');
        // ? set data for  DOM manipulation
        dom.innerHTML = editor.getData(); 
        let get_img =  dom.querySelector(`[data-annotate="${dataAnnotate}"]`);
        let insert_tag = get_img.closest('insert');
        var figID = $(insert_tag).parents('.fig').attr('id');
        insert_tag.parentElement.removeChild(insert_tag);
        NoteRenumber_Temp(editor, dom);
        window.top.parent.SET_DATA.setNewData(dom,{DOM_Empty:!0, reGenerateAll: !0, cleanHTML: !0},figID);
        // editor.setData(dom.innerHTML);
        // TODO to handle
        window.top.parent.ImageAnnotateDialog.closeDialog();
    });
    function NoteRenumber_Temp(editor,dom){
        var mList = $(dom).find('[data-class="ckcommentsfull"][data-status]'), nInd=1, qInd=1;
        $.each(mList, function(x,y){
            if(this.parentElement.hasAttribute('data-action-hidden')) return true;
            var IsQuery = $(this).attr('data-label').indexOf('AQ') != -1?true:false,
                IsLab = IsQuery?('AQ'+qInd):('C'+nInd);
            this.setAttribute('data-label', IsLab);
            IsQuery?(qInd++):(nInd++);
        });
    }
    function myopen(s, t) {
        var popupLeft, popupTop; var mouseX, mouseY, windowWidth, windowHeight;
        mouseX = s.mouseEvent.clientX;
        mouseY = s.mouseEvent.clientY;
        windowWidth = s.mouseEvent.target.getAttribute('Width');
        windowHeight = s.mouseEvent.target.getAttribute('Height');

        var popupWidth = 202; var popupHeight = 162;
        if (this.offsetLeft != undefined)
            mouseX = e.pageX - this.offsetLeft;
        if (this.offsetTop != undefined)
            mouseY = e.pageY; - this.offsetTop;

        if (mouseX < 0)
            mouseX = 0;
        if (mouseY < 0)
            mouseY = 0;
        var dv = this.Ze();
        // var pop = this.Ye();

        if (mouseX + popupWidth > windowWidth)
            popupLeft = mouseX - popupWidth;
        else
            popupLeft = mouseX;

        if (mouseY + popupHeight > windowHeight)
            popupTop = mouseY - popupHeight;
        else
            popupTop = mouseY;

        if (popupLeft < s.mouseEvent.target.scrollLeft) {
            popupLeft = s.mouseEvent.target.scrollLeft;
        }

        if (popupTop < s.mouseEvent.target.scrollTop) {
            popupTop = s.mouseEvent.target.scrollTop;
        }

        if (popupLeft < 0 || popupLeft == undefined)
            popupLeft = 0;
        if (popupTop < 0 || popupTop == undefined)
            popupTop = 0;

        t.editor.setPosition(new W(popupLeft, popupTop + 4));
        t.editor.open(n, s);
    }
    </script>
</body >
</html >
